stages:
  - publish_build_to_pre_qa

.skip-ci:
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[ci skip\]/

publish_build_to_pre_qa:
  extends: .skip-ci
  stage: publish_build_to_pre_qa
  artifacts:
    when: always
    paths:
      - artifacts/*
  image: python:3.8-alpine
  script:
    - mkdir -p artifacts
    - pip install requests
    - VERSION=$(git tag --sort=-creatordate | head -n 1)
    - echo "Build version: $VERSION"
    # Upload ESS-ContentUpdate build to Pre-QA
    - python security_content_automation/publish_build_to_pre_qa/publish_build_to_pre_qa.py --version $VERSION --builds DA-ESS-ContentUpdate
    # Upload SSA-Content build to Pre-QA
    - python security_content_automation/publish_build_to_pre_qa/publish_build_to_pre_qa.py --version $VERSION --builds SSA_Content
  after_script:
    - cp publish_build_to_pre_qa.log artifacts/publish_build_to_pre_qa.log
  only:
    - tags
